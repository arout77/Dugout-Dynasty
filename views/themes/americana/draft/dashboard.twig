{% extends "layouts/main.twig" %}

{% block content %}
<div class="min-h-screen bg-gray-100" id="draft-app">
    
    <!-- --- HUD --- -->
    <div class="bg-indigo-600 text-white sticky top-0 z-40 shadow-lg">
        <div class="container mx-auto px-4 py-3 flex justify-between items-center">
            <div class="flex items-center gap-4">
                <div>
                    <h1 class="text-xl font-bold tracking-wider">{{ userTeam['team_name'] }}</h1>
                    <div class="text-sm text-blue-200">
                        Round <span id="hud-round">{{ ((status.pick_number - 1) // totalTeams) + 1 }}</span> | 
                        Pick <span id="hud-pick">{{ status.pick_number }}</span>
                    </div>
                </div>
            </div>
            
            <div class="flex gap-8 text-center items-center">
                <!-- SIMULATE REST BUTTON (Always Visible) -->
                <div>
                    <button onclick="finishDraft()" class="bg-yellow-600 hover:bg-yellow-500 text-white px-3 py-2 rounded font-bold shadow text-xs uppercase tracking-wide transition transform hover:scale-105 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                        </svg>
                        Simulate Draft
                    </button>
                </div>
                <div>
                    <div class="text-xs uppercase text-blue-200">Salary Cap</div>
                    <div class="text-2xl font-mono text-green-400" id="hud-cap">
                        ${{ salaryCap|number_format }}
                    </div>
                </div>
                <div class="hidden md:block">
                    <div class="text-xs uppercase text-blue-300">Roster Size</div>
                    <div class="text-2xl font-mono font-bold" id="hud-roster">
                        {{ rosterCount }} / 26
                    </div>
                </div>
                <button onclick="toggleRoster()" class="ml-4 bg-pink-600 hover:bg-pink-500 text-white px-4 py-2 rounded shadow flex items-center gap-2 transition">
                    <span>My Roster</span>
                </button>
            </div>
        </div>
        <!-- TICKER BAR -->
        <div class="bg-red-700 text-red-100 text-xs py-1  overflow-hidden relative whitespace-nowrap">
            <div class="inline-block animate-marquee pl-4" id="draft-ticker">
                Loading recent picks...
            </div>
        </div>
    </div>

    <!-- --- MAIN CONTENT --- -->
    <div class="container mx-auto px-4 py-6">
        <div class="bg-white rounded-lg shadow overflow-hidden">
            
            <!-- Tabs -->
            <div class="border-b border-gray-200 bg-gray-50">
                <nav class="flex overflow-x-auto" aria-label="Tabs">
                    <button onclick="setFilter('hitter', 'all')" class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent active">All Hitters</button>
                    {% for pos in ['C', '1B', '2B', '3B', 'SS', 'LF', 'CF', 'RF'] %}
                    <button onclick="setFilter('hitter', '{{ pos }}')" class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent">{{ pos }}</button>
                    {% endfor %}
                    <div class="w-px h-8 bg-gray-300 mx-2 self-center"></div>
                    <button onclick="setFilter('pitcher', 'SP')" class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent">Starters</button>
                    <button onclick="setFilter('pitcher', 'RP')" class="tab-btn px-4 py-3 text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 border-b-2 border-transparent">Relievers</button>
                </nav>
                <!-- Search Box -->
                <div class="relative w-full sm:w-64">
                    <input type="text" id="player-search" placeholder="Search player..." 
                        class="w-full pl-10 pr-4 py-2 rounded-full border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent text-sm"
                        onkeyup="handleSearch(this.value)">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <svg class="h-5 w-5 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                        </svg>
                    </div>
                </div>
            </div>

            <!-- Player Table -->
            <div class="overflow-x-auto min-h-[600px]">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50 font-bold" id="table-header">
                        <!-- JS Injects Headers Here -->
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200 text-sm" id="player-table-body">
                        <tr><td class="text-center py-10 text-gray-500">Loading...</td></tr>
                    </tbody>
                </table>
            </div>
            
            <!-- Pagination -->
            <div class="bg-gray-50 px-4 py-3 border-t border-gray-200 flex items-center justify-between sm:px-6">
                <button onclick="changePage(-1)" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Previous</button>
                <span id="page-indicator" class="text-sm text-gray-700">Page 1</span>
                <button onclick="changePage(1)" class="relative inline-flex items-center px-4 py-2 border border-gray-300 text-sm font-medium rounded-md text-gray-700 bg-white hover:bg-gray-50">Next</button>
            </div>
        </div>
    </div>

    <!-- --- SLIDING ROSTER PANEL --- -->
    <div id="roster-backdrop" onclick="toggleRoster()" class="fixed inset-0 bg-black bg-opacity-50 z-40 hidden transition-opacity duration-300 opacity-0"></div>
    <div id="roster-panel" class="fixed inset-y-0 right-0 w-full max-w-md bg-white shadow-2xl z-50 transform translate-x-full transition-transform duration-300 ease-in-out overflow-y-auto">
        <div class="p-6">
            <div class="flex justify-between items-center border-b pb-4 mb-6">
                <h3 class="text-xl font-bold text-blue-900">My Roster</h3>
                <button onclick="toggleRoster()" class="text-gray-500 hover:text-gray-700">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                </button>
            </div>
            <div class="bg-blue-50 p-4 rounded-lg mb-6 grid grid-cols-2 gap-4 text-center">
                <div>
                    <div class="text-xs text-blue-600 uppercase font-bold">Remaining Cap</div>
                    <div class="text-lg font-mono font-bold text-green-600" id="panel-cap">${{ salaryCap|number_format }}</div>
                </div>
                <div>
                    <div class="text-xs text-blue-600 uppercase font-bold">Spots Filled</div>
                    <div class="text-lg font-mono font-bold text-blue-800" id="panel-count">{{ rosterCount }} / 26</div>
                </div>
            </div>
            <div class="mb-8"><h4 class="text-sm font-bold text-gray-500 uppercase mb-3 border-b pb-1">Pitching Staff</h4><ul class="space-y-2" id="roster-pitchers"></ul></div>
            <div class="mb-12"><h4 class="text-sm font-bold text-gray-500 uppercase mb-3 border-b pb-1">Lineup & Bench</h4><ul class="space-y-2" id="roster-hitters"></ul></div>
        </div>
    </div>
</div>

<style>
/* Improved Marquee Animation */
@keyframes marquee {
  0% { transform: translateX(100vw); } /* Start off-screen right */
  100% { transform: translateX(-100%); } /* End completely off-screen left */
}
.animate-marquee {
  animation: marquee 90s linear infinite; /* Slower speed (30s) for readability */
  padding-left: 0; /* Reset padding */
  white-space: nowrap;
}

/* For instant start look, we can actually just use a very long duration or specific start */
/* This version ensures it flows from right to left continuously */
</style>

<script>
    let BASE_URL = "{{ base_url }}";
    if (BASE_URL.includes("\{\{")) { BASE_URL = ""; }
    if (BASE_URL.endsWith('/')) { BASE_URL = BASE_URL.slice(0, -1); }

    let initialCap = {{ salaryCap }};
    let totalTeams = {{ totalTeams }}; 
    // Added 'search' to state
    let state = { type: 'hitter', pos: 'all', sort: 'PRICE', dir: 'DESC', page: 1, search: '' };

    const hitterCols = [
        { key: 'AB', label: 'AB' }, { key: 'R', label: 'R' }, { key: 'H', label: 'H' },
        { key: '2B', label: '2B' }, { key: '3B', label: '3B' }, { key: 'HR', label: 'HR' },
        { key: 'RBI', label: 'RBI' }, { key: 'SO', label: 'K' }, { key: 'BB', label: 'BB' },
        { key: 'BA', label: 'BA' }, { key: 'OBP', label: 'OBP' }, { key: 'SLG', label: 'SLG' },
        { key: 'SB', label: 'SB' }
    ];

    const pitcherCols = [
        { key: 'G', label: 'G' }, { key: 'GS', label: 'GS' }, { key: 'CG', label: 'CG' },
        { key: 'SHO', label: 'SHO' }, { key: 'W', label: 'W' }, { key: 'L', label: 'L' },
        { key: 'IP', label: 'IP' }, { key: 'H', label: 'H' }, { key: 'SO', label: 'K' },
        { key: 'BB', label: 'BB' }, { key: 'HR', label: 'HR' }, { key: 'ERA', label: 'ERA' },
        { key: 'WHIP', label: 'WHIP' }
    ];

    document.addEventListener('DOMContentLoaded', () => {
        updateHeader(); 
        fetchPlayers();
        updateMyRoster();
        updateTicker();
    });

    // New Search Handler (Debounced slightly by typing speed naturally, or add timeout if needed)
    let searchTimeout;
    function handleSearch(val) {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            state.search = val;
            state.page = 1;
            fetchPlayers();
        }, 300);
    }

    async function updateTicker() {
        try {
            const res = await fetch(`${BASE_URL}/api/draft/recent-picks`);
            if (res.ok) {
                const data = await res.json();
                let html = '';
                data.picks.forEach(p => {
                    const salary = '$' + (p.salary / 1000000).toFixed(1) + 'M';
                    html += `<span class="mx-4 font-mono text-blue-200">|</span> <span class="font-bold text-white">${p.team_name}</span> selects <span class="text-yellow-300">${p.player_name}</span> (${p.position}) ${salary}`;
                });
                if (data.picks.length > 0 && data.picks.length < 5) {
                     html += html + html; 
                }
                document.getElementById('draft-ticker').innerHTML = html;
            }
        } catch(e) { console.error("Ticker error", e); }
        setTimeout(updateTicker, 15000);
    }

    function getStat(p, key) {
        if (key === 'BA' || key === 'AVG') {
            if (p['BA'] !== undefined) return p['BA'];
            if (p['AVG'] !== undefined) return p['AVG'];
            if (p['ba'] !== undefined) return p['ba'];
            if (p['avg'] !== undefined) return p['avg'];
        }
        if (key === 'SO' || key === 'K') {
            if (p['SO'] !== undefined) return p['SO'];
            if (p['K'] !== undefined) return p['K'];
            if (p['so'] !== undefined) return p['so'];
            if (p['k'] !== undefined) return p['k'];
        }
        let val = p[key] ?? p[key.toUpperCase()] ?? p[key.toLowerCase()];
        if (val === undefined || val === null) return '-';
        return val;
    }

    function updateHeader() {
        const cols = state.type === 'hitter' ? hitterCols : pitcherCols;
        let html = `<tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer min-w-[200px]" onclick="sort('NAME')">Player</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer min-w-[100px]" onclick="sort('PRICE')">Salary</th>`;
        
        cols.forEach(col => {
            html += `<th class="px-2 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider cursor-pointer whitespace-nowrap hover:text-blue-600" onclick="sort('${col.key}')">${col.label}</th>`;
        });

        html += `<th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase tracking-wider sticky right-0 bg-gray-50 shadow-l">Action</th></tr>`;
        
        document.getElementById('table-header').innerHTML = html;
    }

    function setFilter(type, pos) {
        state.type = type;
        state.pos = pos;
        state.page = 1;
        document.querySelectorAll('.tab-btn').forEach(el => {
            el.classList.remove('border-blue-500', 'text-blue-600', 'active');
            el.classList.add('border-transparent');
        });
        event.target.classList.remove('border-transparent');
        event.target.classList.add('border-blue-500', 'text-blue-600', 'active');
        updateHeader();
        fetchPlayers();
    }

    function changePage(delta) {
        if (state.page + delta < 1) return;
        state.page += delta;
        fetchPlayers();
    }

    function sort(column) {
        if (state.sort === column) {
            state.dir = state.dir === 'DESC' ? 'ASC' : 'DESC';
        } else {
            state.sort = column;
            state.dir = 'DESC';
        }
        fetchPlayers();
    }

    async function fetchPlayers() {
        const tbody = document.getElementById('player-table-body');
        const colspan = (state.type === 'hitter' ? hitterCols.length : pitcherCols.length) + 3;
        tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-10"><div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-900 mx-auto"></div></td></tr>`;

        try {
            const qs = new URLSearchParams(state).toString();
            const res = await fetch(`${BASE_URL}/api/draft/players?${qs}`);
            const data = await res.json();
            renderTable(data.players);
            document.getElementById('page-indicator').innerText = `Page ${state.page}`;
        } catch (err) {
            console.error(err);
            tbody.innerHTML = `<tr><td colspan="${colspan}" class="text-center py-4 text-red-500">Error loading players.</td></tr>`;
        }
    }

    function renderTable(players) {
        const tbody = document.getElementById('player-table-body');
        if (players.length === 0) {
            tbody.innerHTML = '<tr><td colspan="100%" class="text-center py-10 text-gray-500">No players found.</td></tr>';
            return;
        }

        const cols = state.type === 'hitter' ? hitterCols : pitcherCols;

        tbody.innerHTML = players.map(p => {
            const id = p.row_id || p.ROW_ID || p.ID || p.id; 
            const name = p.NAME || p.Name;
            const year = p.YR || p.Year || '????';
            const fielding = getStat(p, 'Fielding') || getStat(p, 'Endurance') || '';
            const price = p.PRICE || p.Price;
            const isPitcher = state.type === 'pitcher';

            let rowHtml = `<tr class="hover:bg-blue-50 transition duration-150 border-b border-gray-100 group">`;
            rowHtml += `
                <td class="px-4 py-3 align-middle">
                    <div class="flex flex-col">
                        <span class="text-sm font-bold text-gray-900">${name}</span>
                        <span class="text-xs text-gray-500 font-mono">${year} <span class="text-blue-600 ml-1">${fielding}</span></span>
                        <span class="text-[10px] text-gray-300">ID: ${id}</span>
                    </div>
                </td>`;
            rowHtml += `<td class="px-4 py-3 align-middle text-sm font-mono font-bold text-green-700">${price}</td>`;
            cols.forEach(col => {
                let val = getStat(p, col.key);
                if (['BA', 'AVG', 'OBP', 'SLG'].includes(col.key)) {
                    val = String(val); 
                    if (val.startsWith('0.')) val = val.substring(1);
                }
                rowHtml += `<td class="px-2 py-3 align-middle font-mono text-gray-700">${val}</td>`;
            });
            rowHtml += `
                <td class="px-4 py-3 align-middle text-right sticky right-0 bg-white group-hover:bg-blue-50 shadow-l">
                    <button onclick="draftPlayer('${id}', '${isPitcher ? 'pitcher' : 'hitter'}')" 
                        class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded shadow-sm text-xs uppercase tracking-wide transition-transform transform active:scale-95">
                        Draft
                    </button>
                </td>
            </tr>`;
            return rowHtml;
        }).join('');
    }

    function toggleRoster() {
        const panel = document.getElementById('roster-panel');
        const backdrop = document.getElementById('roster-backdrop');
        if (panel.classList.contains('translate-x-full')) {
            panel.classList.remove('translate-x-full');
            backdrop.classList.remove('hidden');
            setTimeout(() => backdrop.classList.remove('opacity-0'), 10);
        } else {
            panel.classList.add('translate-x-full');
            backdrop.classList.add('opacity-0');
            setTimeout(() => backdrop.classList.add('hidden'), 300);
        }
    }

    function changePage(delta) {
        if (state.page + delta < 1) return;
        state.page += delta;
        fetchPlayers();
    }

    function sort(column) {
        if (state.sort === column) {
            state.dir = state.dir === 'DESC' ? 'ASC' : 'DESC';
        } else {
            state.sort = column;
            state.dir = 'DESC';
        }
        fetchPlayers();
    }

    async function draftPlayer(id, type) {
        if (!confirm("Draft this player?")) return;
        try {
            const csrfToken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || '';
            const res = await fetch(`${BASE_URL}/api/draft/pick`, {
                method: 'POST',
                headers: {'Content-Type': 'application/json', 'X-CSRF-TOKEN': csrfToken},
                body: JSON.stringify({ player_id: id, player_type: type })
            });
            const data = await res.json();
            if (data.error) {
                alert(data.error);
            } else {
                // Update HUD directly
                document.getElementById('hud-cap').innerText = '$' + new Intl.NumberFormat().format(data.remaining_cap);
                document.getElementById('panel-cap').innerText = '$' + new Intl.NumberFormat().format(data.remaining_cap);
                
                if (data.draft_status && data.draft_status.status === 'human_turn') {
                    const pick = data.draft_status.pick_number;
                    document.getElementById('hud-pick').innerText = pick;
                    document.getElementById('hud-round').innerText = Math.floor((pick - 1) / totalTeams) + 1; 
                }
                fetchPlayers();
                updateMyRoster(); 
                updateTicker(); 
                
                if (data.draft_status && data.draft_status.status === 'finished') {
                    window.location.href = `${BASE_URL}/pregame`;
                }
            }
        } catch (err) {
            alert("Failed to submit pick.");
        }
    }

    async function finishDraft() {
        if (!confirm("Are you sure? The CPU will simulate the rest of the draft.")) return;
        
        try {
            // NEW: Finish Draft API Call
            const res = await fetch(`${BASE_URL}/api/draft/finish`, { method: 'POST' });
            const data = await res.json();
            if (data.success) {
                window.location.href = `${BASE_URL}/pregame`;
            } else {
                alert("Failed to finish draft.");
            }
        } catch(e) {
            console.error(e);
            alert("Error communicating with server.");
        }
    }

    async function updateMyRoster() {
        const res = await fetch(`${BASE_URL}/api/draft/my-roster`); 
        if(res.ok) {
             const data = await res.json();
             const countStr = `${data.roster.length} / 26`;
             document.getElementById('hud-roster').innerText = countStr;
             document.getElementById('panel-count').innerText = countStr;
             document.getElementById('panel-cap').innerText = '$' + new Intl.NumberFormat().format(initialCap);
             renderRosterPanel(data.roster);
        }
    }

    function renderRosterPanel(roster) {
        const spSlots = Array(5).fill('SP');
        const rpSlots = Array(5).fill('RP');
        const sps = roster.filter(p => p.position === 'SP');
        const rps = roster.filter(p => p.position === 'RP' || p.position === 'P'); 
        let pitchHtml = '';
        for (let i = 0; i < 5; i++) { pitchHtml += renderSlot('SP', sps[i]); }
        for (let i = 0; i < 5; i++) { pitchHtml += renderSlot('RP', rps[i]); }
        const usedIds = [...sps.slice(0,5), ...rps.slice(0,5)].filter(x=>x).map(x => x.player_id);
        roster.filter(p => (p.position === 'SP' || p.position === 'RP' || p.position === 'P') && !usedIds.includes(p.player_id)).forEach(p => {
            pitchHtml += renderSlot(p.position, p);
        });
        document.getElementById('roster-pitchers').innerHTML = pitchHtml;

        const required = ['C','1B','2B','3B','SS','LF','CF','RF'];
        let hitHtml = '';
        let usedHitters = [];
        required.forEach(pos => {
            const p = roster.find(x => x.position === pos && !usedHitters.includes(x.player_id));
            if (p) usedHitters.push(p.player_id);
            hitHtml += renderSlot(pos, p);
        });
        const benchPlayers = roster.filter(p => !['SP','RP','P'].includes(p.position) && !usedHitters.includes(p.player_id));
        benchPlayers.forEach(p => { hitHtml += renderSlot('Bench', p); });
        const emptyBenchCount = Math.max(0, 8 - benchPlayers.length);
        for(let i=0; i<emptyBenchCount; i++) { hitHtml += renderSlot('Bench', null); }
        document.getElementById('roster-hitters').innerHTML = hitHtml;
    }

    function renderSlot(label, player) {
        if (player) {
            return `<div class="flex items-center justify-between text-sm border-b border-gray-100 pb-1 last:border-0">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-blue-600 w-8">${label}</span>
                    <span class="text-gray-900 font-medium truncate w-32">${player.player_name}</span>
                </div>
                <div class="text-xs text-gray-500">'${String(player.season_year).slice(-2)}</div>
            </div>`;
        } else {
            return `<div class="flex items-center justify-between text-sm border-b border-gray-100 pb-1 last:border-0">
                <div class="flex items-center gap-2">
                    <span class="font-bold text-gray-300 w-8">${label}</span>
                    <span class="text-gray-300 italic">Empty</span>
                </div>
            </div>`;
        }
    }
</script>
{% endblock %}